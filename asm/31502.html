<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Back to Skool: Routine at 31502</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../skool.css" />
<link rel="stylesheet" type="text/css" href="../bts.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="31462.html">31462</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#31502">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="31572.html">31572</a></span></td>
</tr>
</table>
<div class="description">31502: Prepare character buffers for released mice</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="31462.html">31462</a>. Releases up to five mice from ERIC's pocket. Each mouse will use a character buffer at page 198, 199 or 206-208, provided that the character who usually occupies it is off-screen.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">DE</td>
<td class="register-desc">Coordinates at which to release the mice</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31502"></a>31502</td>
<td class="instruction">LD H,198</td>
<td class="comment-11" rowspan="2">Use buffers 198 and 199 (little boys nos. 9 and 10) for released mice if possible</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31504"></a>31504</td>
<td class="instruction">LD B,2</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31506"></a>31506</td>
<td class="instruction">CALL 31514</td>
<td class="comment-11" rowspan="1">Prepare these buffers</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31509"></a>31509</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return if ERIC has no mice left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31510"></a>31510</td>
<td class="instruction">LD H,206</td>
<td class="comment-11" rowspan="2">Also use buffers 206-208 (BOY WANDER, ANGELFACE and EINSTEIN) for released mice if possible</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31512"></a>31512</td>
<td class="instruction">LD B,3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31514"></a>31514</td>
<td class="instruction">LD L,18</td>
<td class="comment-11" rowspan="2">Pick up the MSB of the uninterruptible subcommand routine address in bytes 17 and 18 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31516"></a>31516</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31517"></a>31517</td>
<td class="instruction">CP 122</td>
<td class="comment-11" rowspan="1">Does the MSB match that of <a class="link" href="31254.html">31254</a>?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31519"></a>31519</td>
<td class="instruction">JR Z,31568</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31521"></a>31521</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=x-coordinate of the character using this buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31523"></a>31523</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31524"></a>31524</td>
<td class="instruction">CP 142</td>
<td class="comment-11" rowspan="1">Is this character inside or close to the girls' skool?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31526"></a>31526</td>
<td class="instruction">JR NC,31568</td>
<td class="comment-11" rowspan="1">Jump if so (we can't use his buffer)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31528"></a>31528</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31529"></a>31529</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31530"></a>31530</td>
<td class="instruction">LD L,15</td>
<td class="comment-11" rowspan="2">Store this in byte 15 of the buffer for retrieval when the mouse dies</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31532"></a>31532</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31533"></a>31533</td>
<td class="instruction">CALL <a class="link" href="25233.html">25233</a></td>
<td class="comment-11" rowspan="3"><span class="register">A</span>=random number between 10 and 41; this determines the lifespan of the mouse</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31536"></a>31536</td>
<td class="instruction">AND 31</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31538"></a>31538</td>
<td class="instruction">ADD A,10</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31540"></a>31540</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">Store this lifespan parameter in byte 16 of the buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31541"></a>31541</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31542"></a>31542</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="4">Place the address of the uninterruptible subcommand routine at <a class="link" href="31254.html">31254</a> into bytes 17 and 18 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31543"></a>31543</td>
<td class="instruction">LD (HL),22</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31545"></a>31545</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31546"></a>31546</td>
<td class="instruction">LD (HL),122</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31548"></a>31548</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="5">Set bytes 19 and 20 to 0 so that the mouse is initially hidden (see <a class="link" href="31254.html">31254</a> for details on how these bytes are used)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31549"></a>31549</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31550"></a>31550</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31551"></a>31551</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31552"></a>31552</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31553"></a>31553</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">Set byte 21 (time remaining before coming out of hiding) to 3, 2 or 1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31554"></a>31554</td>
<td class="instruction">LD (HL),B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31555"></a>31555</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">Store the x-coordinate of the mouse in byte 22, so it appears there when it comes out of hiding</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31556"></a>31556</td>
<td class="instruction">LD (HL),E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31557"></a>31557</td>
<td class="instruction">LD L,2</td>
<td class="comment-11" rowspan="2">Store the y-coordinate in byte 2</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31559"></a>31559</td>
<td class="instruction">LD (HL),D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31560"></a>31560</td>
<td class="instruction">LD A,(32737)</td>
<td class="comment-11" rowspan="1"><a class="link" href="32737.html">32737</a> holds the number of mice ERIC has caught</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31563"></a>31563</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="2">One fewer now</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31564"></a>31564</td>
<td class="instruction">LD (32737),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31567"></a>31567</td>
<td class="instruction">RET Z</td>
<td class="comment-11" rowspan="1">Return if ERIC has no mice left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31568"></a>31568</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Point to the next potential buffer for a released mouse</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31569"></a>31569</td>
<td class="instruction">DJNZ 31514</td>
<td class="comment-11" rowspan="1">Jump back until all have been considered</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31571"></a>31571</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="31462.html">31462</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#31502">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="31572.html">31572</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Back to Skool RAM disassembly 20140614</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd (Back to Skool). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>