<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Back to Skool: Routine at 27954</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../bts.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Back to Skool" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="27953.html">27953</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#27954">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="28002.html">28002</a></span></td>
</tr>
</table>
<div class="description">27954: Check whether a target character can be seen by another character</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a class="link" href="28002.html">28002</a> and <a class="link" href="28029.html">28029</a>. This routine checks through <span class="register">B'</span> 'spotter' characters starting with character <span class="register">H'</span>. If any spotter is close enough to the target to be able to see it, the routine returns with <span class="register">A</span> holding a non-zero value, <span class="register">H</span> holding the spotter's character number, and the carry flag set if the spotter is facing the right way to see it (reset otherwise). If no spotters are close enough to the target to be able to see it, the routine returns with <span class="register">A</span> holding 0 and the carry flag reset.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">B</td>
<td class="register-desc">Upper x-coordinate of the target range</td>
</tr>
<tr>
<td class="register">C</td>
<td class="register-desc">Lower x-coordinate of the target range</td>
</tr>
<tr>
<td class="register">D</td>
<td class="register-desc">Target character's y-coordinate</td>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">Target character's x-coordinate</td>
</tr>
<tr>
<td class="register">B'</td>
<td class="register-desc">Number of spotters to check</td>
</tr>
<tr>
<td class="register">H'</td>
<td class="register-desc">Character number of the first spotter to check</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27954"></a>27954</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27955"></a>27955</td>
<td class="instruction">LD L,2</td>
<td class="comment-11" rowspan="4">Pick up the spotter's coordinates in <span class="register">DE'</span>; we are going to check whether this character can see the target</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27957"></a>27957</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27958"></a>27958</td>
<td class="instruction">DEC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27959"></a>27959</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27960"></a>27960</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1">Transfer the spotter's y-coordinate to <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27961"></a>27961</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27962"></a>27962</td>
<td class="instruction">SUB D</td>
<td class="comment-11" rowspan="1">Subtract the target's y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27963"></a>27963</td>
<td class="instruction">JR NC,27967</td>
<td class="comment-11" rowspan="1">Jump if the spotter is below or level with the target</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27965"></a>27965</td>
<td class="instruction">NEG</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27967"></a>27967</td>
<td class="instruction">CP 4</td>
<td class="comment-11" rowspan="1">Is the spotter within 3 y-coordinates of the target?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27969"></a>27969</td>
<td class="instruction">JR NC,27980</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27971"></a>27971</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27972"></a>27972</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=spotter's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27973"></a>27973</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27974"></a>27974</td>
<td class="instruction">CP C</td>
<td class="comment-11" rowspan="4">Compare this with the lower and upper limits of the range within which the target can be seen, and jump to <a class="link" href="27954.html#27987">27987</a> if the spotter is within seeing range</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27975"></a>27975</td>
<td class="instruction">JR C,27980</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27977"></a>27977</td>
<td class="instruction">CP B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27978"></a>27978</td>
<td class="instruction">JR C,27987</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="27980"></a>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a class="link" href="28002.html">28002</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27980"></a>27980</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="27981"></a>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a class="link" href="28029.html">28029</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27981"></a>27981</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="2">The last spotter was not within seeing range of the target; try the next spotter</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27982"></a>27982</td>
<td class="instruction">DJNZ 27955</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27984"></a>27984</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27985"></a>27985</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">Signal: none of the spotters was within range</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27986"></a>27986</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="27987"></a>
<div class="comments">
<div class="paragraph">
We've found a spotter within seeing range of the target. But is he facing the right way?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27987"></a>27987</td>
<td class="instruction">CP E</td>
<td class="comment-11" rowspan="1">Does the spotter's x-coordinate match the target's?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27988"></a>27988</td>
<td class="instruction">JR Z,27999</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27990"></a>27990</td>
<td class="instruction">LD A,0</td>
<td class="comment-11" rowspan="1">The carry flag is now set if the spotter is to the left of the target</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27992"></a>27992</td>
<td class="instruction">RRA</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=128 if the spotter is to the left of the target, 0 if to the right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27993"></a>27993</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27994"></a>27994</td>
<td class="instruction">LD L,0</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL'</span> at the spotter's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27996"></a>27996</td>
<td class="instruction">XOR (HL)</td>
<td class="comment-11" rowspan="1">Compare this orientation with the direction in which the spotter is facing</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27997"></a>27997</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27998"></a>27998</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27999"></a>27999</td>
<td class="instruction">CCF</td>
<td class="comment-11" rowspan="1">Set the carry flag if the spotter's facing the right way to see the target</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28000"></a>28000</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1">Set <span class="register">A</span> to something non-zero to indicate that the spotter was within range</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="28001"></a>28001</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="27953.html">27953</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#27954">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="28002.html">28002</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Back to Skool RAM disassembly 20150415</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd (Back to Skool). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>