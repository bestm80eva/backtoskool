<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Back to Skool: Routine at 24348</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../skool.css" />
<link rel="stylesheet" type="text/css" href="../bts.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="24328.html">24328</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#24348">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="24476.html">24476</a></span></td>
</tr>
</table>
<div class="description">24348: 'K' pressed - kiss</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
The address of this routine is found in the table of keypress handling routines at <a class="link" href="58704.html">58704</a>. It is called from the main loop at <a class="link" href="63210.html">63210</a> when 'K' is pressed.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">ERIC's animatory state</td>
</tr>
<tr>
<td class="register">D</td>
<td class="register-desc">ERIC's y-coordinate</td>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">ERIC's x-coordinate</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24348"></a>24348</td>
<td class="instruction">LD HL,53504</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0 of HAYLEY's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24351"></a>24351</td>
<td class="instruction">XOR (HL)</td>
<td class="comment-11" rowspan="2">Are ERIC and HAYLEY facing the same way?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24352"></a>24352</td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24353"></a>24353</td>
<td class="instruction">JR NC,24378</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24355"></a>24355</td>
<td class="instruction">BIT 2,(HL)</td>
<td class="comment-11" rowspan="1">Is HAYLEY standing up?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24357"></a>24357</td>
<td class="instruction">JR NZ,24378</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24359"></a>24359</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=HAYLEY's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24360"></a>24360</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="7"><span class="register">A</span>=x-coordinate of the position two spaces in front of HAYLEY</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24361"></a>24361</td>
<td class="instruction">SBC A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24362"></a>24362</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24363"></a>24363</td>
<td class="instruction">CPL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24364"></a>24364</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24365"></a>24365</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24366"></a>24366</td>
<td class="instruction">ADD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24367"></a>24367</td>
<td class="instruction">CP E</td>
<td class="comment-11" rowspan="1">Does ERIC's x-coordinate match this?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24368"></a>24368</td>
<td class="instruction">JR NZ,24378</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24370"></a>24370</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=2</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24371"></a>24371</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=HAYLEY's y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24372"></a>24372</td>
<td class="instruction">SUB D</td>
<td class="comment-11" rowspan="2">Jump if ERIC's y-coordinate does not match HAYLEY's, or ERIC has used up all his kisses</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24373"></a>24373</td>
<td class="instruction">JR NZ,24378</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24375"></a>24375</td>
<td class="instruction">LD L,18</td>
<td class="comment-11" rowspan="2">Set the zero flag if there is no uninterruptible subcommand routine address in HAYLEY's buffer (<span class="register">A</span>=0)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24377"></a>24377</td>
<td class="instruction">CP (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24378"></a>
<div class="comments">
<div class="paragraph">
At this point the zero flag is set if HAYLEY is kissable (i.e. ERIC and HAYLEY are standing and facing each other at close proximity, and ERIC hasn't already used up all his kisses), and reset otherwise.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24378"></a>24378</td>
<td class="instruction">LD A,1</td>
<td class="comment-11" rowspan="1"><a class="link" href="../graphics/as.html#1">1</a>: ERIC midstride</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24380"></a>24380</td>
<td class="instruction">LD HL,53796</td>
<td class="comment-11" rowspan="1">At <a class="link" href="53796.html">53796</a> lies a RET instruction</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24383"></a>24383</td>
<td class="instruction">JP NZ,<a class="link" href="57637.html#57642">57642</a></td>
<td class="comment-11" rowspan="1">Jump if HAYLEY is not kissable at this time</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24386"></a>24386</td>
<td class="instruction">LD A,(32738)</td>
<td class="comment-11" rowspan="1"><a class="link" href="32738.html">32738</a> holds HAYLEY's kiss counter</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24389"></a>24389</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Has ERIC used up all his kisses?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24390"></a>24390</td>
<td class="instruction">JR NZ,24395</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24392"></a>24392</td>
<td class="instruction">LD HL,24328</td>
<td class="comment-11" rowspan="1"><a class="link" href="24328.html">24328</a>: hit ERIC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24395"></a>24395</td>
<td class="instruction">LD (53521),HL</td>
<td class="comment-11" rowspan="1">Place the appropriate uninterruptible subcommand routine address (<a class="link" href="24328.html">24328</a>: hit ERIC, or <a class="link" href="53796.html">53796</a>: do nothing) into bytes 17 and 18 of HAYLEY's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24398"></a>24398</td>
<td class="instruction">JR Z,24372</td>
<td class="comment-11" rowspan="1">Make HAYLEY hit ERIC if he's used up all his kisses</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24400"></a>
<div class="comments">
<div class="paragraph">
ERIC has scored a kiss.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24400"></a>24400</td>
<td class="instruction">SUB 7</td>
<td class="comment-11" rowspan="1">Subtract 7 from the kiss counter</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24402"></a>24402</td>
<td class="instruction">JR NC,24405</td>
<td class="comment-11" rowspan="1">Jump if that doesn't take it below zero</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24404"></a>24404</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">Set it to zero otherwise</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24405"></a>24405</td>
<td class="instruction">LD (32738),A</td>
<td class="comment-11" rowspan="1">Store the new kiss count at <a class="link" href="32738.html">32738</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24408"></a>24408</td>
<td class="instruction">LD HL,(32743)</td>
<td class="comment-11" rowspan="1"><a class="link" href="32743.html">32743</a> holds the lines total (divided by 10)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24411"></a>24411</td>
<td class="instruction">LD BC,65436</td>
<td class="comment-11" rowspan="1"><span class="register">BC</span>=-100</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24414"></a>24414</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24415"></a>24415</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-11" rowspan="1">Subtract 1000 from the lines total</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24416"></a>24416</td>
<td class="instruction">JR C,24420</td>
<td class="comment-11" rowspan="1">Jump if the lines total (in <span class="register">HL</span>) is still positive</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24418"></a>24418</td>
<td class="instruction">LD H,A</td>
<td class="comment-11" rowspan="2">Otherwise set <span class="register">HL</span>=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24419"></a>24419</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24420"></a>24420</td>
<td class="instruction">LD (32743),HL</td>
<td class="comment-11" rowspan="1">Decrease ERIC's lines total by 1000 (or to 0)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24423"></a>24423</td>
<td class="instruction">CALL <a class="link" href="29643.html">29643</a></td>
<td class="comment-11" rowspan="1">Print the number of lines</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24426"></a>24426</td>
<td class="instruction">LD H,209</td>
<td class="comment-11" rowspan="1">209=HAYLEY</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24428"></a>24428</td>
<td class="instruction">CALL <a class="link" href="25012.html">25012</a></td>
<td class="comment-11" rowspan="1">Update the SRB for HAYLEY's current animatory state and location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24431"></a>24431</td>
<td class="instruction">LD L,20</td>
<td class="comment-11" rowspan="2">Save HAYLEY's current animatory state in byte 20 of her buffer for later retrieval</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24433"></a>24433</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24434"></a>24434</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="2">Save HAYLEY's current x-coordinate in byte 19 of her buffer for later retrieval</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24435"></a>24435</td>
<td class="instruction">LD (HL),E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24436"></a>24436</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="2">Set HAYLEY's x-coordinate to 224 (out of sight) briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24438"></a>24438</td>
<td class="instruction">LD (HL),224</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24440"></a>24440</td>
<td class="instruction">LD H,210</td>
<td class="comment-11" rowspan="1">210=ERIC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24442"></a>24442</td>
<td class="instruction">CALL <a class="link" href="25012.html">25012</a></td>
<td class="comment-11" rowspan="1">Update the SRB for ERIC's current animatory state and location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24445"></a>24445</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 1 of ERIC's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24447"></a>24447</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="1">Is ERIC facing right (bit 7 set)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24448"></a>24448</td>
<td class="instruction">JR C,24452</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24450"></a>24450</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24451"></a>24451</td>
<td class="instruction">DEC (HL)</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24452"></a>24452</td>
<td class="instruction">INC (HL)</td>
<td class="comment-11" rowspan="1">Move ERIC one space forward for the snog (which pushes ERIC through the closed skool gate if he kisses HAYLEY from behind it; this is a <a class="link" href="../reference/bugs.html#kiss">bug</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24453"></a>24453</td>
<td class="instruction">LD A,15</td>
<td class="comment-11" rowspan="1"><a class="link" href="../graphics/as.html#15">15</a>: ERIC and HAYLEY kissing</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24455"></a>24455</td>
<td class="instruction">CALL <a class="link" href="24247.html">24247</a></td>
<td class="comment-11" rowspan="1">Adjust ERIC's animatory state, update the SRB, and return to <a class="link" href="24348.html#24458">24458</a> (below) next time</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24458"></a>24458</td>
<td class="instruction">CALL <a class="link" href="62178.html#62404">62404</a></td>
<td class="comment-11" rowspan="1">Make a sound effect</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24461"></a>24461</td>
<td class="instruction">LD HL,53523</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 19 of HAYLEY's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24464"></a>24464</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="1">Pick up HAYLEY's pre-kiss x-coordinate in <span class="register">E</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24465"></a>24465</td>
<td class="instruction">LD L,2</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 2 of HAYLEY's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24467"></a>24467</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">D</span>=HAYLEY's y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24468"></a>24468</td>
<td class="instruction">CALL <a class="link" href="30643.html#30653">30653</a></td>
<td class="comment-11" rowspan="1">Restore HAYLEY's pre-kiss coordinates and animatory state and update the SRB</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24471"></a>24471</td>
<td class="instruction">LD H,210</td>
<td class="comment-11" rowspan="1">210=ERIC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24473"></a>24473</td>
<td class="instruction">JP <a class="link" href="24263.html#24290">24290</a></td>
<td class="comment-11" rowspan="1">Detach ERIC from HAYLEY's embrace</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="24328.html">24328</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#24348">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="24476.html">24476</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Back to Skool RAM disassembly 20140614</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd (Back to Skool). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>