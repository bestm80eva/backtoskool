<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Back to Skool: Routine at 27672</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../bts.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Back to Skool" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="27671.html">27671</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#27672">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="27803.html">27803</a></span></td>
</tr>
</table>
<div class="description">27672: Alter UDG references in the play area for a door, a window, a cup or the bike</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a class="link" href="24028.html">24028</a>, <a class="link" href="27860.html">27860</a>, <a class="link" href="28736.html">28736</a> and <a class="link" href="64077.html">64077</a>. The UDG reference tables used by this routine are organised into entries of four bytes each. Each entry corresponds to a single UDG within the matrix of UDGs for the door, window, cup or bike:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Byte</th>
<th colspan="1" rowspan="1">Contents</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">1</td>
<td class="" colspan="1" rowspan="1">y-coordinate</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">2</td>
<td class="" colspan="1" rowspan="1">x-coordinate</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">3</td>
<td class="" colspan="1" rowspan="1">UDG reference</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">4 (bits 0-3)</td>
<td class="" colspan="1" rowspan="1">BRIGHT/PAPER attributes</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">4 (bits 6 &amp; 7)</td>
<td class="" colspan="1" rowspan="1">UDG base page identifier</td>
</tr>
</table>
</div>
<div class="paragraph">
The data tables used are located as follows:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Address</th>
<th colspan="1" rowspan="1">Object</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="56637.html">56637</a></td>
<td class="" colspan="1" rowspan="1">Left study door (closed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="56893.html">56893</a></td>
<td class="" colspan="1" rowspan="1">Left study door (open)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="57088.html">57088</a></td>
<td class="" colspan="1" rowspan="1">Right study door (closed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="57344.html">57344</a></td>
<td class="" colspan="1" rowspan="1">Right study door (open)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="56576.html">56576</a></td>
<td class="" colspan="1" rowspan="1">Science Lab storeroom door (closed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="56832.html">56832</a></td>
<td class="" colspan="1" rowspan="1">Science Lab storeroom door (open)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="57149.html">57149</a></td>
<td class="" colspan="1" rowspan="1">Boys' skool door (closed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="57405.html">57405</a></td>
<td class="" colspan="1" rowspan="1">Boys' skool door (open)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="63744.html">63744</a></td>
<td class="" colspan="1" rowspan="1">Skool gate (closed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="64000.html">64000</a></td>
<td class="" colspan="1" rowspan="1">Skool gate (open)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="56064.html">56064</a></td>
<td class="" colspan="1" rowspan="1">Drinks cabinet door (closed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="56320.html">56320</a></td>
<td class="" colspan="1" rowspan="1">Drinks cabinet door (open)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="55040.html">55040</a></td>
<td class="" colspan="1" rowspan="1">Top-floor window (closed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="55296.html">55296</a></td>
<td class="" colspan="1" rowspan="1">Top-floor window (open)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="55552.html">55552</a></td>
<td class="" colspan="1" rowspan="1">Middle-floor window (closed)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="55808.html">55808</a></td>
<td class="" colspan="1" rowspan="1">Middle-floor window (open)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="56081.html">56081</a></td>
<td class="" colspan="1" rowspan="1">Cups in the boys' skool (empty)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="56694.html">56694</a></td>
<td class="" colspan="1" rowspan="1">Leftmost cup in the boys' skool (containing water)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="56699.html">56699</a></td>
<td class="" colspan="1" rowspan="1">Leftmost cup in the boys' skool (containing sherry)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="56950.html">56950</a></td>
<td class="" colspan="1" rowspan="1">Middle cup in the boys' skool (containing water)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="56955.html">56955</a></td>
<td class="" colspan="1" rowspan="1">Middle cup in the boys' skool (containing sherry)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="57206.html">57206</a></td>
<td class="" colspan="1" rowspan="1">Rightmost cup in the boys' skool (containing water)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="57211.html">57211</a></td>
<td class="" colspan="1" rowspan="1">Rightmost cup in the boys' skool (containing sherry)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="56337.html">56337</a></td>
<td class="" colspan="1" rowspan="1">Cup in the girls' skool (empty)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="57462.html">57462</a></td>
<td class="" colspan="1" rowspan="1">Cup in the girls' skool (containing water)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="57467.html">57467</a></td>
<td class="" colspan="1" rowspan="1">Cup in the girls' skool (containing sherry)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="57600.html">57600</a></td>
<td class="" colspan="1" rowspan="1">Tree (with no bike attached)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1"><a class="link" href="57856.html">57856</a></td>
<td class="" colspan="1" rowspan="1">Tree (with bike attached)</td>
</tr>
</table>
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">UDG reference table address</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27672"></a>27672</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">Pick up the y-coordinate (Y) in <span class="register">D</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27673"></a>27673</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27674"></a>27674</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="2">Return if we found the end-of-table marker (255)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27675"></a>27675</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27676"></a>27676</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 2 of this table entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27677"></a>27677</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the x-coordinate (X) in <span class="register">E</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27678"></a>27678</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 3 of this table entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27679"></a>27679</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27680"></a>27680</td>
<td class="instruction">LD A,(32767)</td>
<td class="comment-11" rowspan="2"><span class="register">C</span>=leftmost column of the play area on screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27683"></a>27683</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27684"></a>27684</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="5">Jump if (X,Y) is off-screen (no need to update the screen refresh buffer)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27685"></a>27685</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27686"></a>27686</td>
<td class="instruction">JR C,27717</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27688"></a>27688</td>
<td class="instruction">CP 32</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27690"></a>27690</td>
<td class="instruction">JR NC,27717</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="27692"></a>
<div class="comments">
<div class="paragraph">
(X,Y) corresponds to a location that is currently on-screen, so we have to update the <a class="link" href="32512.html">screen refresh buffer</a> (SRB).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27692"></a>27692</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">0&lt;=<span class="register">C</span>&lt;=31 (screen x-coordinate)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27693"></a>27693</td>
<td class="instruction">AND 7</td>
<td class="comment-11" rowspan="4">Point <span class="register">HL</span> at an entry in the 8-byte table at <a class="link" href="57720.html">57720</a>, whose contents are (128, 64, 32, 16, 8, 4, 2, 1)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27695"></a>27695</td>
<td class="instruction">ADD A,120</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27697"></a>27697</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27698"></a>27698</td>
<td class="instruction">LD H,225</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27700"></a>27700</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="1">Pick up this entry in <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27701"></a>27701</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1">0&lt;=<span class="register">A</span>&lt;=31 (screen x-coordinate)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27702"></a>27702</td>
<td class="instruction">RRCA</td>
<td class="comment-11" rowspan="10">Point <span class="register">HL</span> at the byte of the SRB corresponding to (X,Y)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27703"></a>27703</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27704"></a>27704</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27705"></a>27705</td>
<td class="instruction">AND 3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27707"></a>27707</td>
<td class="instruction">ADD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27708"></a>27708</td>
<td class="instruction">ADD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27709"></a>27709</td>
<td class="instruction">ADD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27710"></a>27710</td>
<td class="instruction">ADD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27711"></a>27711</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27712"></a>27712</td>
<td class="instruction">LD H,127</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27714"></a>27714</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="3">Set the appropriate bit in the SRB byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27715"></a>27715</td>
<td class="instruction">OR B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27716"></a>27716</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="27717"></a>
<div class="comments">
<div class="paragraph">
The UDG reference (i.e. the LSB of the base address of the skool UDG) for the skool location (X,Y) must be modified to reflect the change in status of the door, window, cup or bike.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27717"></a>27717</td>
<td class="instruction">LD L,E</td>
<td class="comment-11" rowspan="2">Point <span class="register">HL</span> at the Q value (0&lt;=Q&lt;=143) in page <a class="link" href="46336.html">181</a> for the x-coordinate X (see <a class="link" href="24684.html">24684</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27718"></a>27718</td>
<td class="instruction">LD H,181</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27720"></a>27720</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the Q value in <span class="register">E</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27721"></a>27721</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="3">Set <span class="register">DE</span> to the address where the UDG reference for (X,Y) is stored</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27722"></a>27722</td>
<td class="instruction">ADD A,160</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27724"></a>27724</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27725"></a>27725</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 3 of the table entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27726"></a>27726</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the replacement UDG reference in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27727"></a>27727</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 4 of the table entry</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27728"></a>27728</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">Replace the UDG reference for the skool location (X,Y) with the one collected from the table entry</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="27729"></a>
<div class="comments">
<div class="paragraph">
The attribute byte for the skool location (X,Y) must be modified too.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27729"></a>27729</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up byte 4 of the table entry in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27730"></a>27730</td>
<td class="instruction">AND 15</td>
<td class="comment-11" rowspan="1">Keep only bits 0-3 (the BRIGHT and PAPER attributes)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27732"></a>27732</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Copy them to <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27733"></a>27733</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Q (0&lt;=Q&lt;=143)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27734"></a>27734</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Save the Q value in <span class="register">C</span> for later</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27735"></a>27735</td>
<td class="instruction">ADD A,104</td>
<td class="comment-11" rowspan="4">Point <span class="register">DE</span> at byte 180+INT(Q/2) of page Y+160, where the BRIGHT and PAPER attributes for the skool location (X,Y) are stored</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27737"></a>27737</td>
<td class="instruction">SCF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27738"></a>27738</td>
<td class="instruction">RRA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27739"></a>27739</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27740"></a>27740</td>
<td class="instruction">JR C,27753</td>
<td class="comment-11" rowspan="1">Jump if Q is odd (BRIGHT and PAPER in bits 0-3)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27742"></a>27742</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="6">Shift the BRIGHT and PAPER attributes from bits 0-3 to bits 4-7 of <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27743"></a>27743</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27744"></a>27744</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27745"></a>27745</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27746"></a>27746</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27747"></a>27747</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27748"></a>27748</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="2">Pick up the current attribute byte for the skool location (X,Y), keeping bits 0-3 as they are</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27749"></a>27749</td>
<td class="instruction">AND 15</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27751"></a>27751</td>
<td class="instruction">JR 27756</td>
<td class="comment-11" rowspan="1">Jump forward to adjust bits 4-7 appropriately</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27753"></a>27753</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="2">Pick up the current attribute byte for the skool location (X,Y), keeping bits 4-7 as they are</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27754"></a>27754</td>
<td class="instruction">AND 240</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27756"></a>27756</td>
<td class="instruction">OR B</td>
<td class="comment-11" rowspan="2">Adjust bits 0-3 (if Q is odd) or bits 4-7 (Q is even) of the attribute byte for the skool location (X,Y)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27757"></a>27757</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="27758"></a>
<div class="comments">
<div class="paragraph">
Finally, the base page (128, 136, 144 or 152) for the new skool UDG reference must be set.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27758"></a>27758</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up byte 4 of the table entry in <span class="register">A</span> again</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27759"></a>27759</td>
<td class="instruction">AND 192</td>
<td class="comment-11" rowspan="1">Keep only bits 6 and 7</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27761"></a>27761</td>
<td class="instruction">BIT 6,A</td>
<td class="comment-11" rowspan="4">Set <span class="register">B</span>=10001000 if these bits are 11, 10000000 (10), 00001000 (01) or 00000000 (00)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27763"></a>27763</td>
<td class="instruction">JR Z,27767</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27765"></a>27765</td>
<td class="instruction">SUB 56</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27767"></a>27767</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27768"></a>27768</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Q</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27769"></a>27769</td>
<td class="instruction">LD C,136</td>
<td class="comment-11" rowspan="1"><span class="register">C</span>=10001000</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27771"></a>27771</td>
<td class="instruction">SRL A</td>
<td class="comment-11" rowspan="10">Set <span class="register">A</span>=INT(Q/4), and shift <span class="register">B</span> and <span class="register">C</span> right (Q AND 3) times</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27773"></a>27773</td>
<td class="instruction">JR NC,27779</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27775"></a>27775</td>
<td class="instruction">RRC B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27777"></a>27777</td>
<td class="instruction">RRC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27779"></a>27779</td>
<td class="instruction">SRL A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27781"></a>27781</td>
<td class="instruction">JR NC,27791</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27783"></a>27783</td>
<td class="instruction">RRC B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27785"></a>27785</td>
<td class="instruction">RRC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27787"></a>27787</td>
<td class="instruction">RRC B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27789"></a>27789</td>
<td class="instruction">RRC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27791"></a>27791</td>
<td class="instruction">ADD A,144</td>
<td class="comment-11" rowspan="2">Point <span class="register">DE</span> at byte 144+INT(Q/4) of page Y+160, where the UDG MSB identifier bit-pair for skool location (X,Y) is held (see <a class="link" href="24684.html">24684</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27793"></a>27793</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27794"></a>27794</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">Pick up the current MSB identifier byte in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27795"></a>27795</td>
<td class="instruction">OR C</td>
<td class="comment-11" rowspan="3">Replace bits (0,4), (1,5), (2,6) or (3,7) in this byte with the corresponding bits in <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27796"></a>27796</td>
<td class="instruction">XOR C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27797"></a>27797</td>
<td class="instruction">OR B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27798"></a>27798</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">Store the new MSB identifier byte</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="27799"></a>
<div class="comments">
<div class="paragraph">
Move to the next entry in the table.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27799"></a>27799</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the first byte of the next entry in the table</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27800"></a>27800</td>
<td class="instruction">JP 27672</td>
<td class="comment-11" rowspan="1">Jump back to process it</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="27671.html">27671</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#27672">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="27803.html">27803</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Back to Skool RAM disassembly 20150415</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd (Back to Skool). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>