<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Back to Skool: Routine at 24684</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../bts.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Back to Skool" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="24677.html">24677</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#24684">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="24878.html">24878</a></span></td>
</tr>
</table>
<div class="description">24684: Print a tile</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routines at <a class="link" href="25026.html">25026</a>, <a class="link" href="25080.html">25080</a> and <a class="link" href="25248.html">25248</a>. Copies a tile of the play area into the back buffer at <a class="link" href="57712.html">57712</a>, superimposes character sprite tiles as appropriate, and then copies the resultant tile to the screen. Also sets the corresponding attribute byte.
</div>
<div class="paragraph">
The play area graphic data is laid out across pages 128 to 181:
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Page(s)</th>
<th colspan="1" rowspan="1">Bytes</th>
<th colspan="1" rowspan="1">Contents</th>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">128-135</td>
<td class="centre" colspan="1" rowspan="1">0-255</td>
<td class="" colspan="1" rowspan="1">Skool graphic data</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">136-143</td>
<td class="centre" colspan="1" rowspan="1">0-255</td>
<td class="" colspan="1" rowspan="1">Skool graphic data</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">144-151</td>
<td class="centre" colspan="1" rowspan="1">0-255</td>
<td class="" colspan="1" rowspan="1">Skool graphic data (except bytes 1, 11, 21, 30)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">152-159</td>
<td class="centre" colspan="1" rowspan="1">0-249</td>
<td class="" colspan="1" rowspan="1">Skool graphic data (except bytes 224-239)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="3">160-180</td>
<td class="centre" colspan="1" rowspan="1">0-143</td>
<td class="" colspan="1" rowspan="1">LSBs of tile base addresses</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">144-179</td>
<td class="" colspan="1" rowspan="1">Tile MSB indicator bit-pairs (see below)</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">180-251</td>
<td class="" colspan="1" rowspan="1">Tile BRIGHT/PAPER attribute nibbles</td>
</tr>
<tr>
<td class="centre" colspan="1" rowspan="1">181</td>
<td class="centre" colspan="1" rowspan="1">0-191</td>
<td class="" colspan="1" rowspan="1">Q (0&lt;=Q&lt;=143; see below)</td>
</tr>
</table>
</div>
<div class="paragraph">
For the tile at skool coordinates (X,Y) (0&lt;=X&lt;=191, 0&lt;=Y&lt;=20), the column pointer Q (0&lt;=Q&lt;=143) is collected from byte X of page <a class="link" href="46336.html">181</a>. Then Q and Y together determine the location of the attribute byte, and where to look up the base address of the tile graphic data.
</div>
<div class="paragraph">
The BRIGHT/PAPER bits for row Y are arranged in a set of 144 nibbles in bytes 180-251 of page Y+160, from bits 7-4 of byte 180 (nibble 0) to bits 3-0 of byte 251 (nibble 143). Q is the index of the nibble in the set of 144 that corresponds to the tile at (X,Y). In other words, the BRIGHT/PAPER bits for the skool location (X,Y) can be found in byte 180+INT(Q/2) of page Y+160: bits 4-7 if Q is even, bits 0-3 if Q is odd.
</div>
<div class="paragraph">
By default, the INK is 0 (black). However, if the BRIGHT/PAPER bits are all 0, this indicates a tile with non-black INK, of which there are normally four: the three shields in MR WACKER's study (which are red, blue, and red), and the top of the entrance to the girls' skool (which is blue). (However, when the left study door is open - which never happens in an unhacked game - there is a fifth tile with non-black INK: the top of the left study doorway, which is magenta.) When a tile has non-black INK, the BRIGHT/PAPER bits are taken from byte 180+INT(Q/2) of page Y+161 (i.e. the attribute byte corresponding to the skool location (X,Y+1)); then the INK is 2 (red) if Q is even, 1 (blue) if 4|Q-1, or 3 (magenta) if 4|Q-3.
</div>
<div class="paragraph">
So much for the attributes. The LSB of the base address of the tile graphic data is found in byte Q of page Y+160. Information on which MSB (128, 136, 144 or 152) applies is arranged in a set of 144 bit-pairs in bytes 144-179 of page Y+160. Bit-pair 0 is bits 7 and 3 of byte 144; bit-pair 1 is bits 6 and 2; bit-pair 2 is bits 5 and 1; bit-pair 3 is bits 4 and 0; bit-pair 4 is bits 7 and 3 of byte 145; and so on up to bit-pair 143, which is bits 4 and 0 of byte 179. Q is the index of the bit-pair in the set of 144 that corresponds to the tile at (X,Y). In other words, the tile MSB indicator for the skool location (X,Y) can be found in byte 144+INT(Q/4) of page Y+160: bits 7 and 3 if 4|Q, 6 and 2 if 4|Q-1, 5 and 1 if 4|Q-2, 4 and 0 if 4|Q-3. The bit-pair forms a 2-digit binary number from 0 to 3; if we call this P, then the MSB is 128+8P.
</div>
<div class="paragraph">
To summarise, then, the attributes and graphic data for the tile at skool location (X,Y) can be found thus, where Q=PEEK(<a class="link" href="46336.html">46336</a>+X):
</div>
<div class="paragraph">
<table class="default">
<tr>
<th colspan="1" rowspan="1">Data</th>
<th colspan="1" rowspan="1">Look at...</th>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">BRIGHT/PAPER</td>
<td class="" colspan="1" rowspan="1">Nibble Q of bytes 180-251 in page Y+160 (or Y+161 if nibble Q in page Y+160 is 0)</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">INK</td>
<td class="" colspan="1" rowspan="1">0 if nibble Q in page Y+160 is not 0; 1, 2 or 3 as explained above otherwise</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">Tile LSB</td>
<td class="" colspan="1" rowspan="1">Byte Q in page Y+160</td>
</tr>
<tr>
<td class="" colspan="1" rowspan="1">Tile MSB</td>
<td class="" colspan="1" rowspan="1">Bit-pair Q of bytes 144-179 in page Y+160</td>
</tr>
</table>
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Screen row number (0-20)</td>
</tr>
<tr>
<td class="register">L</td>
<td class="register-desc">Screen column number (0-31)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24684"></a>24684</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24685"></a>24685</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="17">Compute the appropriate attribute file address in <span class="register">BC</span> and the appropriate display file address in <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24686"></a>24686</td>
<td class="instruction">AND 24</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24688"></a>24688</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24689"></a>24689</td>
<td class="instruction">LD A,H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24690"></a>24690</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24691"></a>24691</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24692"></a>24692</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24693"></a>24693</td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24694"></a>24694</td>
<td class="instruction">AND 224</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24696"></a>24696</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24697"></a>24697</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24698"></a>24698</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24699"></a>24699</td>
<td class="instruction">LD A,H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24700"></a>24700</td>
<td class="instruction">AND 3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24702"></a>24702</td>
<td class="instruction">ADD A,88</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24704"></a>24704</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24705"></a>24705</td>
<td class="instruction">SET 6,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24707"></a>24707</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="2">Place the display file address on the stack and get (row,col) back in <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24708"></a>24708</td>
<td class="instruction">EX (SP),HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24709"></a>24709</td>
<td class="instruction">LD A,(32767)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=leftmost column of the play area on screen (0-160)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24712"></a>24712</td>
<td class="instruction">ADD A,L</td>
<td class="comment-11" rowspan="2"><span class="register">L</span>=X: column of the play area corresponding to the character square under consideration (0-191)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24713"></a>24713</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24714"></a>24714</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">Push the skool coordinates (X,Y) onto the stack</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24715"></a>24715</td>
<td class="instruction">LD A,H</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Y (0-20)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24716"></a>24716</td>
<td class="instruction">LD H,181</td>
<td class="comment-11" rowspan="1"><span class="register">HL</span>=<a class="link" href="46336.html">46336</a>+X</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24718"></a>24718</td>
<td class="instruction">LD L,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=Q (0&lt;=Q&lt;=143)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24719"></a>24719</td>
<td class="instruction">ADD A,160</td>
<td class="comment-11" rowspan="2"><span class="register">H</span>=Y+160</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24721"></a>24721</td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24722"></a>24722</td>
<td class="instruction">LD E,L</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=Q (0&lt;=Q&lt;=143)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24723"></a>24723</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Q</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24724"></a>24724</td>
<td class="instruction">RRA</td>
<td class="comment-11" rowspan="1">Is Q odd?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24725"></a>24725</td>
<td class="instruction">JR C,24754</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24727"></a>
<div class="comments">
<div class="paragraph">
Q (the contents of (<a class="link" href="46336.html">46336</a>+X)) is even, which means the PAPER colour and BRIGHT status can be found in bits 4-7 of byte 180+Q/2 in page Y+160. At this point <span class="register">A</span>=Q/2.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24727"></a>24727</td>
<td class="instruction">ADD A,180</td>
<td class="comment-11" rowspan="1">180&lt;=<span class="register">A</span>&lt;=251</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24729"></a>24729</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the attribute byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24730"></a>24730</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the attribute byte in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24731"></a>24731</td>
<td class="instruction">AND 240</td>
<td class="comment-11" rowspan="1">The PAPER colour and BRIGHT status are in bits 4-7</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24733"></a>24733</td>
<td class="instruction">RR A</td>
<td class="comment-11" rowspan="1">Shift them into bits 3-6</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24735"></a>24735</td>
<td class="instruction">JR NZ,24774</td>
<td class="comment-11" rowspan="1">Jump if this character square has INK 0</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24737"></a>
<div class="comments">
<div class="paragraph">
We are dealing with one of the few character squares with non-black INK. In this case the PAPER colour and BRIGHT status can be found in bits 4-7 (since Q is even) of byte 180+Q/2 in page Y+161.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24737"></a>24737</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the attribute byte in page Y+161</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24738"></a>24738</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the attribute byte in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24739"></a>24739</td>
<td class="instruction">AND 240</td>
<td class="comment-11" rowspan="1">The PAPER colour and BRIGHT status are in bits 4-7</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24741"></a>24741</td>
<td class="instruction">RRA</td>
<td class="comment-11" rowspan="1">Shift them into bits 3-6</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24742"></a>24742</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1"><span class="register">L</span> holds the PAPER colour and BRIGHT status</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24743"></a>24743</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=Q (0&lt;=Q&lt;=143)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24744"></a>24744</td>
<td class="instruction">AND 3</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=0, 1, 2 or 3</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24746"></a>24746</td>
<td class="instruction">JR NZ,24750</td>
<td class="comment-11" rowspan="1">Jump if the INK is blue, red, or magenta</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24748"></a>24748</td>
<td class="instruction">ADD A,2</td>
<td class="comment-11" rowspan="1">A=2: INK 2 (red)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24750"></a>24750</td>
<td class="instruction">OR L</td>
<td class="comment-11" rowspan="1">OR on the PAPER colour and BRIGHT status</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24751"></a>24751</td>
<td class="instruction">DEC H</td>
<td class="comment-11" rowspan="1"><span class="register">H</span>=Y+160</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24752"></a>24752</td>
<td class="instruction">JR 24774</td>
<td class="comment-11" rowspan="1">Jump forward to transfer the attribute byte in <span class="register">A</span> onto the screen</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24754"></a>
<div class="comments">
<div class="paragraph">
Q (the contents of (<a class="link" href="46336.html">46336</a>+X)) is odd, which means the PAPER colour and BRIGHT status can be found in bits 0-3 of byte 180+(Q-1)/2 in page Y+160. At this point <span class="register">A</span>=(Q-1)/2.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24754"></a>24754</td>
<td class="instruction">ADD A,180</td>
<td class="comment-11" rowspan="1">180&lt;=<span class="register">A</span>&lt;=251</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24756"></a>24756</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the attribute byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24757"></a>24757</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the attribute byte in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24758"></a>24758</td>
<td class="instruction">AND 15</td>
<td class="comment-11" rowspan="1">The PAPER colour and BRIGHT status are in bits 0-3</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24760"></a>24760</td>
<td class="instruction">JR NZ,24771</td>
<td class="comment-11" rowspan="1">Jump if this character square has INK 0</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24762"></a>
<div class="comments">
<div class="paragraph">
We are dealing with one of the few character squares with non-black INK. In this case the PAPER colour and BRIGHT status can be found in bits 0-3 (since Q is odd) of byte 180+(Q-1)/2 in page Y+161.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24762"></a>24762</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at the attribute byte in page Y+161</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24763"></a>24763</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the attribute byte in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24764"></a>24764</td>
<td class="instruction">AND 15</td>
<td class="comment-11" rowspan="1">The PAPER colour and BRIGHT status are in bits 0-3</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24766"></a>24766</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="3">Shift the PAPER and BRIGHT bits from bits 0-3 to bits 3-6</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24767"></a>24767</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24768"></a>24768</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24769"></a>24769</td>
<td class="instruction">JR 24742</td>
<td class="comment-11" rowspan="1">Jump back to fill in the INK bits</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24771"></a>24771</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="3">Shift the PAPER and BRIGHT bits from bits 0-3 to bits 3-6, and set the INK to 0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24772"></a>24772</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24773"></a>24773</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24774"></a>24774</td>
<td class="instruction">NOP</td>
<td class="comment-11" rowspan="1">Do nothing (during the startup sequence), or poke the attribute byte onto the screen (this instruction is set to LD (BC),A before the game starts; see <a class="link" href="21408.html">21408</a>)</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24775"></a>
<div class="comments">
<div class="paragraph">
The appropriate attribute byte has been poked onto the screen. Now to find the appropriate tile graphic data.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24775"></a>24775</td>
<td class="instruction">LD L,E</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=Q (0&lt;=Q&lt;=143), <span class="register">H</span>=Y+160</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24776"></a>24776</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=LSB of the base address of the tile graphic data</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24777"></a>24777</td>
<td class="instruction">LD A,136</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=10001000</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24779"></a>24779</td>
<td class="instruction">SRL L</td>
<td class="comment-11" rowspan="7">Shift <span class="register">A</span> right (Q AND 3) times</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24781"></a>24781</td>
<td class="instruction">JR NC,24784</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24783"></a>24783</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24784"></a>24784</td>
<td class="instruction">SRL L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24786"></a>24786</td>
<td class="instruction">JR NC,24790</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24788"></a>24788</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24789"></a>24789</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24790"></a>24790</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1"><span class="register">C</span>=10001000, 01000100, 00100010 or 00010001</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24791"></a>24791</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="3">Point <span class="register">HL</span> at the byte containing the MSB indicator bit-pair: <span class="register">H</span>=Y+160, 144&lt;=<span class="register">L</span>=144+INT(Q/4)&lt;=179</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24792"></a>24792</td>
<td class="instruction">ADD A,144</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24794"></a>24794</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24795"></a>24795</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=10001000, 01000100, 00100010 or 00010001</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24796"></a>24796</td>
<td class="instruction">AND (HL)</td>
<td class="comment-11" rowspan="1">Keep only the bits of the bit-pair</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24797"></a>
<div class="comments">
<div class="paragraph">
The base page of the tile graphic data depends on the bits set in <span class="register">A</span>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24797"></a>24797</td>
<td class="instruction">LD D,128</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24799"></a>24799</td>
<td class="instruction">CP 16</td>
<td class="comment-11" rowspan="1">Are any of bits 4-7 in <span class="register">A</span> set?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24801"></a>24801</td>
<td class="instruction">JR C,24805</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24803"></a>24803</td>
<td class="instruction">LD D,144</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24805"></a>24805</td>
<td class="instruction">AND 15</td>
<td class="comment-11" rowspan="1">Are any of bits 0-3 in <span class="register">A</span> set?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24807"></a>24807</td>
<td class="instruction">JR Z,24811</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24809"></a>24809</td>
<td class="instruction">SET 3,D</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24811"></a>
<div class="comments">
<div class="paragraph">
Now <span class="register">D</span>=128, 136, 144 or 152, and <span class="register">DE</span> points at the first byte of the graphic data for the tile at skool coordinates (X,Y).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24811"></a>24811</td>
<td class="instruction">LD HL,57712</td>
<td class="comment-11" rowspan="2">We're going to copy the tile into the 8-byte back buffer at <a class="link" href="57712.html">57712</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24814"></a>24814</td>
<td class="instruction">LD B,8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24816"></a>24816</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">Use a blank graphic byte (during startup), or collect the tile graphic byte (this instruction is set to LD A,(DE) before the game starts; see <a class="link" href="21408.html">21408</a>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24817"></a>24817</td>
<td class="instruction">INC D</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE</span> at the next graphic byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24818"></a>24818</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Copy the graphic byte into the back buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24819"></a>24819</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Move to the next slot in the back buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24820"></a>24820</td>
<td class="instruction">DJNZ 24816</td>
<td class="comment-11" rowspan="1">Jump back until the entire tile has been copied</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24822"></a>
<div class="comments">
<div class="paragraph">
The appropriate play area tile has been copied into the back buffer at <a class="link" href="57712.html">57712</a>. Now it's time to superimpose game character sprite tiles (if any).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24822"></a>24822</td>
<td class="instruction">LD H,183</td>
<td class="comment-11" rowspan="1">183=character number of little girl no. 1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24824"></a>24824</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1"><span class="register">D</span>=Y (0-20), <span class="register">E</span>=X (0-191)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24825"></a>24825</td>
<td class="instruction">LD A,(32767)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=leftmost column of the play area on screen (0-160)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24828"></a>24828</td>
<td class="instruction">CP 120</td>
<td class="comment-11" rowspan="1">120=roughly halfway between the tree and the gate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24830"></a>24830</td>
<td class="instruction">JR C,24843</td>
<td class="comment-11" rowspan="1">Jump if columns 144 onwards (girls' skool + half the girls' playground) are off-screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24832"></a>24832</td>
<td class="instruction">LD B,7</td>
<td class="comment-11" rowspan="1">7 little girls</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24834"></a>24834</td>
<td class="instruction">CALL <a class="link" href="24576.html">24576</a></td>
<td class="comment-11" rowspan="1">Superimpose graphic bytes for the little girls if necessary</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24837"></a>24837</td>
<td class="instruction">LD H,198</td>
<td class="comment-11" rowspan="1">198=character number of little boy no. 9</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24839"></a>24839</td>
<td class="instruction">LD B,17</td>
<td class="comment-11" rowspan="1">2 little boys, 11 main characters, plus the objects using character buffers 211-214</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24841"></a>24841</td>
<td class="instruction">JR 24862</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24843"></a>24843</td>
<td class="instruction">CP 80</td>
<td class="comment-11" rowspan="1">80=assembly hall stage (or thereabouts)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24845"></a>24845</td>
<td class="instruction">JR C,24858</td>
<td class="comment-11" rowspan="1">Jump if columns 104 onwards (everything to the right of the tree, roughly) are off-screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24847"></a>24847</td>
<td class="instruction">LD B,3</td>
<td class="comment-11" rowspan="1">3 little girls (183-185)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24849"></a>24849</td>
<td class="instruction">CALL <a class="link" href="24576.html">24576</a></td>
<td class="comment-11" rowspan="1">Superimpose graphic bytes for these little girls if necessary</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24852"></a>24852</td>
<td class="instruction">LD H,193</td>
<td class="comment-11" rowspan="1">193=character number of little boy no. 4</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24854"></a>24854</td>
<td class="instruction">LD B,22</td>
<td class="comment-11" rowspan="1">7 little boys, 11 main characters, plus the objects using character buffers 211-214</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24856"></a>24856</td>
<td class="instruction">JR 24862</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24858"></a>24858</td>
<td class="instruction">LD H,190</td>
<td class="comment-11" rowspan="1">190=character number of little boy no. 1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24860"></a>24860</td>
<td class="instruction">LD B,25</td>
<td class="comment-11" rowspan="1">All 10 little boys, 11 main characters, plus the objects using character buffers 211-214</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24862"></a>24862</td>
<td class="instruction">CALL <a class="link" href="24576.html">24576</a></td>
<td class="comment-11" rowspan="1">Superimpose graphic bytes for these characters if necessary</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24865"></a>24865</td>
<td class="instruction">LD HL,57712</td>
<td class="comment-11" rowspan="1">The 8-byte back buffer at <a class="link" href="57712.html">57712</a> now contains the tile to be copied to the screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24868"></a>24868</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">Retrieve the appropriate display file address in <span class="register">DE</span></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24869"></a>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a class="link" href="26941.html">26941</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24869"></a>24869</td>
<td class="instruction">LD B,8</td>
<td class="comment-11" rowspan="1">There are 8 bytes per character square</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24871"></a>24871</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="5">Transfer the graphic bytes to the screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24872"></a>24872</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24873"></a>24873</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24874"></a>24874</td>
<td class="instruction">INC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24875"></a>24875</td>
<td class="instruction">DJNZ 24871</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24877"></a>24877</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="24677.html">24677</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#24684">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="24878.html">24878</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Back to Skool RAM disassembly 20150415</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd (Back to Skool). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>