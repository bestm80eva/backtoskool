<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Back to Skool: Routine at 63915</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../skool.css" />
<link rel="stylesheet" type="text/css" href="../bts.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="63898.html">63898</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#63915">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="63996.html">63996</a></span></td>
</tr>
</table>
<div class="description">63915: Control water fired from the pistol (1)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
The address of this routine is placed into <a class="link" href="32727.html">32727</a> by the routine at <a class="link" href="63898.html">63898</a>. In the following, 'water' may refer to either water or sherry.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">210 (ERIC)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="63915"></a>63915</td>
<td class="instruction">LD B,84</td>
<td class="comment-11" rowspan="1"><a class="link" href="../graphics/as.html#84">84</a>: water fired from the pistol, phase 1 (facing left)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63917"></a>63917</td>
<td class="instruction">LD L,0</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0 of ERIC's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63919"></a>63919</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=ERIC's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63920"></a>63920</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63921"></a>63921</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="1">Is ERIC facing left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63922"></a>63922</td>
<td class="instruction">JR NC,63926</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63924"></a>63924</td>
<td class="instruction">LD B,212</td>
<td class="comment-11" rowspan="1"><a class="link" href="../graphics/as.html#212">212</a>: water fired from the pistol, phase 1 (facing right)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="63926"></a>63926</td>
<td class="instruction">SBC A,A</td>
<td class="comment-11" rowspan="4">Set <span class="register">A</span>=-2 if ERIC's facing left, 2 if he's facing right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63927"></a>63927</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63928"></a>63928</td>
<td class="instruction">CPL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63929"></a>63929</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63930"></a>63930</td>
<td class="instruction">ADD A,(HL)</td>
<td class="comment-11" rowspan="1">Add ERIC's x-coordinate to get the initial x-coordinate of the water</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63931"></a>63931</td>
<td class="instruction">CP 191</td>
<td class="comment-11" rowspan="1">Is ERIC too close to (and facing) the far left wall of the boys' skool or the far right wall of the girls' skool?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63933"></a>63933</td>
<td class="instruction">RET NC</td>
<td class="comment-11" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63934"></a>63934</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">Copy the water's initial x-coordinate to <span class="register">E</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63935"></a>63935</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=2</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63936"></a>63936</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">D</span>=ERIC's y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63937"></a>63937</td>
<td class="instruction">DEC D</td>
<td class="comment-11" rowspan="2">Subtract 2 to get the initial y-coordinate of the water</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63938"></a>63938</td>
<td class="instruction">DEC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63939"></a>63939</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=initial animatory state of the water</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63940"></a>63940</td>
<td class="instruction">PUSH AF</td>
<td class="comment-11" rowspan="1">Save the water's initial animatory state briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63941"></a>63941</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">Save the water's initial coordinates briefly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63942"></a>63942</td>
<td class="instruction">CALL <a class="link" href="63861.html#63864">63864</a></td>
<td class="comment-11" rowspan="1">Make a water pistol sound effect</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63945"></a>63945</td>
<td class="instruction">LD A,136</td>
<td class="comment-11" rowspan="1">Message <a class="link" href="64591.html">136</a>: NO WATERPISTOLS</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63947"></a>63947</td>
<td class="instruction">CALL <a class="link" href="63586.html#63640">63640</a></td>
<td class="comment-11" rowspan="1">Give ERIC lines if any teacher is nearby</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63950"></a>63950</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">Restore the water's initial coordinates to <span class="register">DE</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63951"></a>63951</td>
<td class="instruction">POP AF</td>
<td class="comment-11" rowspan="1">Restore the water's initial animatory state to <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63952"></a>63952</td>
<td class="instruction">LD HL,54803</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 19 of the water's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63955"></a>63955</td>
<td class="instruction">LD (HL),151</td>
<td class="comment-11" rowspan="1">Initialise the water animation phase identifier</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63957"></a>63957</td>
<td class="instruction">CALL <a class="link" href="30534.html">30534</a></td>
<td class="comment-11" rowspan="1">Place address <a class="link" href="63915.html#63960">63960</a> (below) into bytes 17 and 18 of the water's buffer and update the SRB for the water's appearance</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="63960"></a>
<div class="comments">
<div class="paragraph">
The address of this entry point is placed into bytes 17 and 18 of the water's buffer by the instruction above just after the water has been fired from the pistol, and is used throughout the water's lifespan. First, check whether the water has hit a cup, a plant, or the floor.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63960"></a>63960</td>
<td class="instruction">LD L,19</td>
<td class="comment-11" rowspan="2">Increment the water animation phase identifier (which starts off at 151) held in byte 19 of the buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63962"></a>63962</td>
<td class="instruction">INC (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63963"></a>63963</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="1">Pick up this identifier (152-156) in <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63964"></a>63964</td>
<td class="instruction">LD C,255</td>
<td class="comment-11" rowspan="1">Point <span class="register">BC</span> at the appropriate entry in the water animation table (see below)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63966"></a>63966</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-11" rowspan="1">Pick up the entry in <span class="register">A</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63967"></a>63967</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">Deal with the water at phase 3 (when it can hit a cup), 6 (when it can hit a plant) or 7+ (when it hits the floor)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63968"></a>63968</td>
<td class="instruction">CALL NZ,<a class="link" href="64077.html">64077</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="63971"></a>
<div class="comments">
<div class="paragraph">
Next, determine the water's new animatory state and coordinates as it moves through the air. For this we use the water animation table, which comprises five 4-byte entries located in bytes 252-255 of pages 152-156, corresponding to the phases of animation of the water as it flies from the pistol to the ground. Each entry contains the animatory state (AS), the x-coordinate increment (x+), the y-coordinate increment (y+), and a parameter (P) that is passed to the routine at <a class="link" href="64077.html">64077</a> when non-zero. When P=1, the water is at the right phase to fill a cup; when P=2, the water may have hit a plant or the ground.
</div>
<div class="paragraph">
<table class="default">
<tr>
<th>Address</th>
<th>Phase</th>
<th>AS</th>
<th>x+</th>
<th>y+</th>
<th>P</th>
</tr>
<tr>
<td class="centre"><a class="link" href="39164.html">39164</a></td>
<td class="centre">2</td>
<td class="centre"><a class="link" href="../graphics/as.html#92">92</a></td>
<td class="centre">-2</td>
<td class="centre">-1</td>
<td class="centre">0</td>
</tr>
<tr>
<td class="centre"><a class="link" href="39420.html">39420</a></td>
<td class="centre">3</td>
<td class="centre"><a class="link" href="../graphics/as.html#108">108</a></td>
<td class="centre">-2</td>
<td class="centre">0</td>
<td class="centre">1</td>
</tr>
<tr>
<td class="centre"><a class="link" href="39676.html">39676</a></td>
<td class="centre">4</td>
<td class="centre"><a class="link" href="../graphics/as.html#116">116</a></td>
<td class="centre">-1</td>
<td class="centre">0</td>
<td class="centre">0</td>
</tr>
<tr>
<td class="centre"><a class="link" href="39932.html">39932</a></td>
<td class="centre">5</td>
<td class="centre"><a class="link" href="../graphics/as.html#124">124</a></td>
<td class="centre">0</td>
<td class="centre">1</td>
<td class="centre">0</td>
</tr>
<tr>
<td class="centre"><a class="link" href="40188.html">40188</a></td>
<td class="centre">6+</td>
<td class="centre"><a class="link" href="../graphics/as.html#124">124</a></td>
<td class="centre">0</td>
<td class="centre">1</td>
<td class="centre">2</td>
</tr>
</table>
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63971"></a>63971</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="1"><span class="register">C</span>=254</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63972"></a>63972</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Save the water animation table pointer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63973"></a>63973</td>
<td class="instruction">CALL <a class="link" href="25012.html">25012</a></td>
<td class="comment-11" rowspan="1">Update the SRB for the water's current animatory state and location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63976"></a>63976</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=water's current y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63977"></a>63977</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">Restore the water animation table pointer to <span class="register">HL</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63978"></a>63978</td>
<td class="instruction">ADD A,(HL)</td>
<td class="comment-11" rowspan="1">Add the entry from the table to obtain the water's new y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63979"></a>63979</td>
<td class="instruction">LD D,A</td>
<td class="comment-11" rowspan="1">Copy this to <span class="register">D</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63980"></a>63980</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=253</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63981"></a>63981</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="1">Pick up the x-coordinate increment in <span class="register">C</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63982"></a>63982</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=252</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63983"></a>63983</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=water's new animatory state (facing left)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63984"></a>63984</td>
<td class="instruction">LD HL,54784</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0 of the water's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63987"></a>63987</td>
<td class="instruction">RL (HL)</td>
<td class="comment-11" rowspan="1">Set the carry flag if the water's travelling to the right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63989"></a>63989</td>
<td class="instruction">RLA</td>
<td class="comment-11" rowspan="2">Copy the carry flag into the 'direction' bit (bit 7) of the animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63990"></a>63990</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63991"></a>63991</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1"><span class="register">B</span>=water's new animatory state (facing the correct way)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63992"></a>63992</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=water's current x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="63993"></a>63993</td>
<td class="instruction">JP <a class="link" href="64057.html">64057</a></td>
<td class="comment-11" rowspan="1">Jump over the data table at <a class="link" href="64000.html">64000</a> to continue this routine</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="63898.html">63898</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#63915">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="63996.html">63996</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Back to Skool RAM disassembly 20140614</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd (Back to Skool). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>