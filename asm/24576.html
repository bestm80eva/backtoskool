<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Back to Skool: Routine at 24576</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../skool.css" />
<link rel="stylesheet" type="text/css" href="../bts.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="24560.html">24560</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#24576">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="24677.html">24677</a></span></td>
</tr>
</table>
<div class="description">24576: Superimpose sprite tiles onto a tile of the play area</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="24684.html">24684</a>. Checks through <span class="register">B</span> characters, starting at character <span class="register">H</span>. If any part of a character's sprite needs to be printed at the row and column specified by <span class="register">DE</span>, the appropriate UDG is located and superimposed onto the contents of the buffer at <a class="link" href="57712.html">57712</a>, which on the first call to this routine contains the appropriate skool UDG (the background).
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">B</td>
<td class="register-desc">Number of characters to consider</td>
</tr>
<tr>
<td class="register">D</td>
<td class="register-desc">Row of play area (0-20)</td>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">Column of play area (0-191)</td>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Number of the first character to consider</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24576"></a>24576</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 1 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24578"></a>24578</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=column of play area (0-191) under consideration</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24579"></a>24579</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="1">Subtract the character's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24580"></a>24580</td>
<td class="instruction">CP 3</td>
<td class="comment-11" rowspan="1">Sprites are three character squares wide</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24582"></a>24582</td>
<td class="instruction">JR NC,24652</td>
<td class="comment-11" rowspan="1">Jump if no part of this character's sprite is in this column</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24584"></a>24584</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24585"></a>24585</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is the character facing left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24587"></a>24587</td>
<td class="instruction">JR Z,24592</td>
<td class="comment-11" rowspan="1">Jump if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24589"></a>24589</td>
<td class="instruction">CPL</td>
<td class="comment-11" rowspan="2">'Flip' the number in <span class="register">A</span>, so 0 becomes 2, 1 remains 1, and 2 becomes 0 (i.e. <span class="register">A</span> becomes 2-<span class="register">A</span>)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24590"></a>24590</td>
<td class="instruction">ADD A,3</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24592"></a>24592</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="3">Now <span class="register">C</span>=0 if the front of the character is in this column, 4 if it's the middle, or 8 if it's the back</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24593"></a>24593</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24594"></a>24594</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24595"></a>24595</td>
<td class="instruction">LD L,2</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 2 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24597"></a>24597</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=row of play area (0-20) under consideration</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24598"></a>24598</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="1">Subtract the character's y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24599"></a>24599</td>
<td class="instruction">CP 4</td>
<td class="comment-11" rowspan="1">Sprites are 4 character squares tall</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24601"></a>24601</td>
<td class="instruction">JR NC,24652</td>
<td class="comment-11" rowspan="1">Jump if no part of this character's sprite is in this row</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24603"></a>24603</td>
<td class="instruction">ADD A,C</td>
<td class="comment-11" rowspan="1">0&lt;=<span class="register">A</span>&lt;=11 (index of the sprite tile at this row and column, where 0=top-front, 4=top-middle, 8=top-back, 11=bottom-back)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24604"></a>24604</td>
<td class="instruction">ADD A,215</td>
<td class="comment-11" rowspan="1">215&lt;=<span class="register">A</span>&lt;=226</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24606"></a>24606</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="3">Set <span class="register">H'</span> to the number of the page containing the UDG reference for the sprite tile</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24607"></a>24607</td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24608"></a>24608</td>
<td class="instruction">EXX</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24609"></a>24609</td>
<td class="instruction">LD L,0</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24611"></a>24611</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's animatory state</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24612"></a>24612</td>
<td class="instruction">OR 128</td>
<td class="comment-11" rowspan="1">Set bit 7 to obtain the LSB of the address that holds the sprite tile UDG reference</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24614"></a>24614</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24615"></a>24615</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="1">128&lt;=<span class="register">L'</span>&lt;=255 (215&lt;=<span class="register">H'</span>&lt;=226)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24616"></a>24616</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=sprite tile UDG reference (73-255)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24617"></a>24617</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is this tile the 'null' UDG (a blank square)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24618"></a>24618</td>
<td class="instruction">JR Z,24651</td>
<td class="comment-11" rowspan="1">Jump if so (no need to superimpose it)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24620"></a>24620</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1"><span class="register">E'</span>=UDG reference (73-255)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24621"></a>24621</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=(normalised) animatory state (128-255)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24622"></a>24622</td>
<td class="instruction">CP 208</td>
<td class="comment-11" rowspan="1"><a class="link" href="../graphics/as.html#208">208</a>=animatory state of MR WACKER, the first teacher</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24624"></a>24624</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24625"></a>24625</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=character's (true) animatory state (0-255)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24626"></a>24626</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24627"></a>24627</td>
<td class="instruction">LD D,183</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE'</span> at the graphic data at page 183 onwards (for animatory states 0-79 and 128-207)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24629"></a>24629</td>
<td class="instruction">JR C,24633</td>
<td class="comment-11" rowspan="1">Jump unless we're dealing with animatory states 80-127 or 208-255 (teachers, ALBERT, and water fired from the pistol)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24631"></a>24631</td>
<td class="instruction">LD D,199</td>
<td class="comment-11" rowspan="1">Point <span class="register">DE'</span> at the graphic data at page 199 onwards (for animatory states 80-127 and 208-255)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24633"></a>24633</td>
<td class="instruction">LD HL,57712</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL'</span> at the UDG back buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24636"></a>24636</td>
<td class="instruction">RLCA</td>
<td class="comment-11" rowspan="1">Push the character's 'direction' bit into the carry flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24637"></a>24637</td>
<td class="instruction">JR C,24656</td>
<td class="comment-11" rowspan="1">Jump if the character is facing right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24639"></a>24639</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24640"></a>24640</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=byte already in the UDG buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24641"></a>24641</td>
<td class="instruction">OR (HL)</td>
<td class="comment-11" rowspan="1">Superimpose the sprite tile byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24642"></a>24642</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL'</span> at the outline mask for this tile byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24643"></a>24643</td>
<td class="instruction">AND (HL)</td>
<td class="comment-11" rowspan="1">AND with this mask</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24644"></a>24644</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL'</span> at the next sprite tile byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24645"></a>24645</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">Place the resultant byte back in the UDG buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24646"></a>24646</td>
<td class="instruction">INC E</td>
<td class="comment-11" rowspan="1">Move <span class="register">DE'</span> along the UDG buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24647"></a>24647</td>
<td class="instruction">BIT 3,E</td>
<td class="comment-11" rowspan="1">Have we done all 8 bytes yet?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24649"></a>24649</td>
<td class="instruction">JR Z,24640</td>
<td class="comment-11" rowspan="1">Jump back if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24651"></a>24651</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24652"></a>24652</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Next game character</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24653"></a>24653</td>
<td class="instruction">DJNZ 24576</td>
<td class="comment-11" rowspan="1">Jump back until all characters have been done</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24655"></a>24655</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="24656"></a>
<div class="comments">
<div class="paragraph">
The character is facing right, so we have to produce a mirror image of the graphic data.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24656"></a>24656</td>
<td class="instruction">LD B,182</td>
<td class="comment-11" rowspan="1">Page <a class="link" href="46592.html">182</a> contains mirror images of 0-255</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="24658"></a>24658</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=sprite tile byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24659"></a>24659</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=mirror image of this byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24660"></a>24660</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24661"></a>24661</td>
<td class="instruction">OR (HL)</td>
<td class="comment-11" rowspan="1">Superimpose what's already in the UDG buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24662"></a>24662</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Put the result so far back in the UDG buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24663"></a>24663</td>
<td class="instruction">INC D</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=outline mask for this sprite tile byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24664"></a>24664</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24665"></a>24665</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="2"><span class="register">A</span>=mirror image of this mask</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24666"></a>24666</td>
<td class="instruction">LD A,(BC)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24667"></a>24667</td>
<td class="instruction">AND (HL)</td>
<td class="comment-11" rowspan="1">AND it with what's in the UDG buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24668"></a>24668</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-11" rowspan="1">Place the result in the UDG buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24669"></a>24669</td>
<td class="instruction">INC D</td>
<td class="comment-11" rowspan="1">Next sprite tile byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24670"></a>24670</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">Next byte of the UDG buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24671"></a>24671</td>
<td class="instruction">BIT 3,L</td>
<td class="comment-11" rowspan="1">Have we done all 8 bytes yet?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24673"></a>24673</td>
<td class="instruction">JR Z,24658</td>
<td class="comment-11" rowspan="1">Jump back if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="24675"></a>24675</td>
<td class="instruction">JR 24651</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="24560.html">24560</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#24576">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="24677.html">24677</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Back to Skool RAM disassembly 20140614</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd (Back to Skool). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>