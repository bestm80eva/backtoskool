<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Back to Skool: Routine at 31150</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../bts.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="Back to Skool" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="31148.html">31148</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#31150">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="31252.html">31252</a></span></td>
</tr>
</table>
<div class="description">31150: Make any female characters near a mouse start or continue jumping</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="31254.html">31254</a>. Does nothing if the mouse is off-screen. Otherwise, for each female character that is facing the mouse and within five spaces to the left or right of it, either (a) makes her stand on a chair or start jumping if she isn't already, or (b) makes her stay on the chair or keep jumping for a little longer.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Mouse's character number (198, 199, 206-208, 212)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31150"></a>31150</td>
<td class="instruction">LD A,(32767)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=leftmost column of the play area on screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31153"></a>31153</td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="1">Copy this to <span class="register">B</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31154"></a>31154</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 1 of the mouse's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31156"></a>31156</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=mouse's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31157"></a>31157</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">Copy this to <span class="register">E</span></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31158"></a>31158</td>
<td class="instruction">SUB B</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31159"></a>31159</td>
<td class="instruction">INC A</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31160"></a>31160</td>
<td class="instruction">CP 32</td>
<td class="comment-11" rowspan="1">Is this mouse off-screen?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31162"></a>31162</td>
<td class="instruction">RET NC</td>
<td class="comment-11" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31163"></a>31163</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1"><span class="register">L</span>=2</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31164"></a>31164</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">D</span>=mouse's y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31165"></a>31165</td>
<td class="instruction">LD H,183</td>
<td class="comment-11" rowspan="1">183=little girl no. 1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31167"></a>31167</td>
<td class="instruction">LD B,7</td>
<td class="comment-11" rowspan="1">There are 7 little girls to check</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31169"></a>31169</td>
<td class="instruction">CALL 31181</td>
<td class="comment-11" rowspan="1">Make them start jumping if necessary</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31172"></a>31172</td>
<td class="instruction">LD H,204</td>
<td class="comment-11" rowspan="1">204=MISS TAKE</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31174"></a>31174</td>
<td class="instruction">INC B</td>
<td class="comment-11" rowspan="1">B=1</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31175"></a>31175</td>
<td class="instruction">CALL 31181</td>
<td class="comment-11" rowspan="1">Make MISS TAKE start jumping if necessary</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31178"></a>31178</td>
<td class="instruction">LD H,209</td>
<td class="comment-11" rowspan="1">209=HAYLEY</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31180"></a>31180</td>
<td class="instruction">INC B</td>
<td class="comment-11" rowspan="1">B=1</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="31181"></a>
<div class="comments">
<div class="paragraph">
At this point <span class="register">H</span> holds the number of the first female character to check, and <span class="register">B</span> the number of characters to check (for proximity to a mouse).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31181"></a>31181</td>
<td class="instruction">LD L,2</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 2 of the female character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31183"></a>31183</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=mouse's y-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31184"></a>31184</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-11" rowspan="1">Subtract that of the female character under consideration</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31185"></a>31185</td>
<td class="instruction">JR Z,31197</td>
<td class="comment-11" rowspan="1">Jump if the female character is standing on the same floor as the mouse</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31187"></a>31187</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="1">Is the female character one level above the mouse?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31188"></a>31188</td>
<td class="instruction">JR NZ,31248</td>
<td class="comment-11" rowspan="1">Jump ahead to consider the next character if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31190"></a>31190</td>
<td class="instruction">LD L,18</td>
<td class="comment-11" rowspan="2">Pick up the MSB of any uninterruptible subcommand routine address in bytes 17 and 18 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31192"></a>31192</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31193"></a>31193</td>
<td class="instruction">CP 121</td>
<td class="comment-11" rowspan="1">Is this character jumping (121=MSB of <a class="link" href="31078.html">31078</a> or <a class="link" href="31092.html">31092</a>)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31195"></a>31195</td>
<td class="instruction">JR NZ,31248</td>
<td class="comment-11" rowspan="1">Jump ahead to consider the next character if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31197"></a>31197</td>
<td class="instruction">LD L,1</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 1 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31199"></a>31199</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">A</span>=female character's x-coordinate</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31200"></a>31200</td>
<td class="instruction">SUB E</td>
<td class="comment-11" rowspan="1">Subtract that of the mouse</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31201"></a>31201</td>
<td class="instruction">LD L,0</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 0 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31203"></a>31203</td>
<td class="instruction">JR Z,31225</td>
<td class="comment-11" rowspan="1">Jump if the girl is standing right where the mouse is</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31205"></a>31205</td>
<td class="instruction">JR NC,31217</td>
<td class="comment-11" rowspan="1">Jump if the girl is standing to the right of the mouse</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31207"></a>31207</td>
<td class="instruction">CP 251</td>
<td class="comment-11" rowspan="1">Is the girl within 5 spaces to the left of the mouse?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31209"></a>31209</td>
<td class="instruction">JR C,31248</td>
<td class="comment-11" rowspan="1">Jump ahead to consider the next character if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31211"></a>31211</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is the female character facing left?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31213"></a>31213</td>
<td class="instruction">JR Z,31248</td>
<td class="comment-11" rowspan="1">Jump ahead to consider the next character if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31215"></a>31215</td>
<td class="instruction">JR 31225</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31217"></a>31217</td>
<td class="instruction">CP 6</td>
<td class="comment-11" rowspan="1">Is the girl within 5 spaces to the right of the mouse?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31219"></a>31219</td>
<td class="instruction">JR NC,31248</td>
<td class="comment-11" rowspan="1">Jump ahead to consider the next character if not</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31221"></a>31221</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="1">Is the female character facing right?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31223"></a>31223</td>
<td class="instruction">JR NZ,31248</td>
<td class="comment-11" rowspan="1">Jump ahead to consider the next character if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="31225"></a>
<div class="comments">
<div class="paragraph">
The female character is located within 5 spaces of the mouse, and is facing it. Figure out whether she's already jumping, or can start jumping.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31225"></a>31225</td>
<td class="instruction">LD L,18</td>
<td class="comment-11" rowspan="2">Pick up the MSB of any uninterruptible subcommand routine address in bytes 17 and 18 of the female character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31227"></a>31227</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31228"></a>31228</td>
<td class="instruction">CP 121</td>
<td class="comment-11" rowspan="1">Set the zero flag if the routine address is <a class="link" href="31078.html">31078</a> or <a class="link" href="31092.html">31092</a> (i.e. the character is already jumping)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31230"></a>31230</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">Point <span class="register">HL</span> at byte 19 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31231"></a>31231</td>
<td class="instruction">JR NZ,31237</td>
<td class="comment-11" rowspan="1">Jump if the character is not jumping</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31233"></a>31233</td>
<td class="instruction">SET 4,(HL)</td>
<td class="comment-11" rowspan="1">Otherwise ensure this character continues jumping for a little longer by setting the counter in byte 19 to at least 16</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31235"></a>31235</td>
<td class="instruction">JR 31248</td>
<td class="comment-11" rowspan="1">Jump ahead to consider the next character</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31237"></a>31237</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is there an uninterruptible subcommand routine address other than <a class="link" href="31078.html">31078</a> or <a class="link" href="31092.html">31092</a> in bytes 17 and 18 of the character's buffer (meaning she is otherwise occupied)?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31238"></a>31238</td>
<td class="instruction">JR NZ,31248</td>
<td class="comment-11" rowspan="1">Jump ahead to consider the next character if so</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="31240"></a>
<div class="comments">
<div class="paragraph">
The female character is not jumping at the moment. Make her start.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31240"></a>31240</td>
<td class="instruction">LD (HL),21</td>
<td class="comment-11" rowspan="2">Set the delay parameter at byte 19 determining how long the female character will jump up and down</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31242"></a>31242</td>
<td class="instruction">DEC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31243"></a>31243</td>
<td class="instruction">LD (HL),121</td>
<td class="comment-11" rowspan="3">Place the address of the uninterruptible subcommand routine at <a class="link" href="31092.html">31092</a> into bytes 17 and 18 of the female character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31245"></a>31245</td>
<td class="instruction">DEC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31246"></a>31246</td>
<td class="instruction">LD (HL),116</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="31248"></a>31248</td>
<td class="instruction">INC H</td>
<td class="comment-11" rowspan="1">Next female character</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31249"></a>31249</td>
<td class="instruction">DJNZ 31181</td>
<td class="comment-11" rowspan="1">Jump back until all the characters have been checked</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="31251"></a>31251</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="31148.html">31148</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#31150">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="31252.html">31252</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Back to Skool RAM disassembly 20150415</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd (Back to Skool). &#169; 2015 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.3.</div>
</div>
</body>
</html>