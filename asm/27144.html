<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Back to Skool: Routine at 27144</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../microsphere.css" />
<link rel="stylesheet" type="text/css" href="../skool.css" />
<link rel="stylesheet" type="text/css" href="../bts.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="27143.html">27143</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#27144">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="27272.html">27272</a></span></td>
</tr>
</table>
<div class="description">27144: Make a character speak</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
The address of this interruptible subcommand routine is placed into bytes 9 and 10 of the character's buffer by the routine at <a class="link" href="61533.html">61533</a>, <a class="link" href="61555.html">61555</a>, <a class="link" href="61696.html">61696</a>, <a class="link" href="62032.html">62032</a> or <a class="link" href="62815.html">62815</a>.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">E</td>
<td class="register-desc">Message number</td>
</tr>
<tr>
<td class="register">H</td>
<td class="register-desc">Character number (200-204, 208)</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27144"></a>27144</td>
<td class="instruction">LD L,11</td>
<td class="comment-11" rowspan="2">Store the message number in byte 11 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27146"></a>27146</td>
<td class="instruction">LD (HL),E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="27147"></a>
<div class="comments">
<div class="paragraph">
The address of this entry point is placed into bytes 9 and 10 of EINSTEIN's buffer by the routine at <a class="link" href="61440.html">61440</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27147"></a>27147</td>
<td class="instruction">LD L,16</td>
<td class="comment-11" rowspan="5">Clear bytes 12-16 of the character's buffer, thus removing the addresses of any old (sub)(sub)messages</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27149"></a>27149</td>
<td class="instruction">LD B,5</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27151"></a>27151</td>
<td class="instruction">LD (HL),0</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27153"></a>27153</td>
<td class="instruction">DEC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27154"></a>27154</td>
<td class="instruction">DJNZ 27151</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27156"></a>27156</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="1"><span class="register">E</span>=message number</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27157"></a>27157</td>
<td class="instruction">LD D,254</td>
<td class="comment-11" rowspan="7">Pick up the address of the message and place it into bytes 11 and 12 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27159"></a>27159</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27160"></a>27160</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27161"></a>27161</td>
<td class="instruction">INC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27162"></a>27162</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27163"></a>27163</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27164"></a>27164</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="27165"></a>
<div class="comments">
<div class="paragraph">
If somebody else is already speaking, this entry point is used while this character waits his turn to speak.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27165"></a>27165</td>
<td class="instruction">LD A,(32760)</td>
<td class="comment-11" rowspan="1"><a class="link" href="32760.html">32760</a> holds the LSB of the SRB address corresponding to the lip of the speech bubble (or 0 if there is no bubble on-screen)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27168"></a>27168</td>
<td class="instruction">LD L,9</td>
<td class="comment-11" rowspan="2">Place the address of the entry point at <a class="link" href="27144.html#27165">27165</a> into bytes 9 and 10 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27170"></a>27170</td>
<td class="instruction">LD (HL),29</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27172"></a>27172</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Is anyone else speaking at the moment?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27173"></a>27173</td>
<td class="instruction">RET NZ</td>
<td class="comment-11" rowspan="1">Return if so</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27174"></a>27174</td>
<td class="instruction">LD (HL),46</td>
<td class="comment-11" rowspan="1">Place the address of the entry point at <a class="link" href="27144.html#27182">27182</a> into bytes 9 and 10 of the character's buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27176"></a>27176</td>
<td class="instruction">CALL <a class="link" href="26958.html">26958</a></td>
<td class="comment-11" rowspan="1">Print the speech bubble if the character's head is on-screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27179"></a>27179</td>
<td class="instruction">RET NC</td>
<td class="comment-11" rowspan="1">Return if the character's head is on-screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27180"></a>27180</td>
<td class="instruction">JR 27205</td>
<td class="comment-11" rowspan="1">Otherwise make this routine relinquish control of the character</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="27182"></a>
<div class="comments">
<div class="paragraph">
This entry point is used while the character is speaking.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27182"></a>27182</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27183"></a>27183</td>
<td class="instruction">CALL <a class="link" href="26849.html">26849</a></td>
<td class="comment-11" rowspan="1">Update the SRB so that the speech bubble is not corrupted</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27186"></a>27186</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27187"></a>27187</td>
<td class="instruction">JR NC,27202</td>
<td class="comment-11" rowspan="1">Jump if the speech bubble is no longer on-screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27189"></a>27189</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="3">Point <span class="register">HL'</span> at the end of the buffer (at <a class="link" href="23296.html">23296</a>) which will contain the speech text graphic data</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27190"></a>27190</td>
<td class="instruction">LD HL,23359</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27193"></a>27193</td>
<td class="instruction">EXX</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27194"></a>27194</td>
<td class="instruction">LD B,2</td>
<td class="comment-11" rowspan="1">We scroll the message two letters at a time</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27196"></a>27196</td>
<td class="instruction">CALL <a class="link" href="26318.html">26318</a></td>
<td class="comment-11" rowspan="1">Collect in <span class="register">A</span> the next character code from the message</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27199"></a>27199</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">Has the message finished?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27200"></a>27200</td>
<td class="instruction">JR NZ,27208</td>
<td class="comment-11" rowspan="1">Jump if not</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="27202"></a>
<div class="comments">
<div class="paragraph">
The message has finished, or the speech bubble has been scrolled off the screen. Either way, the character has finished speaking.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27202"></a>27202</td>
<td class="instruction">CALL <a class="link" href="26910.html">26910</a></td>
<td class="comment-11" rowspan="1">Update the SRB to get rid of the speech bubble</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27205"></a>27205</td>
<td class="instruction">JP <a class="link" href="25484.html#25488">25488</a></td>
<td class="comment-11" rowspan="1">Terminate this interruptible subcommand</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="27208"></a>
<div class="comments">
<div class="paragraph">
The character has not finished speaking.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27208"></a>27208</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27209"></a>27209</td>
<td class="instruction">CALL <a class="link" href="27110.html">27110</a></td>
<td class="comment-11" rowspan="1">Roll the font character bitmap into the message buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27212"></a>27212</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27213"></a>27213</td>
<td class="instruction">DJNZ 27196</td>
<td class="comment-11" rowspan="1">Jump back until two more letters have been rolled into the buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27215"></a>27215</td>
<td class="instruction">LD L,29</td>
<td class="comment-11" rowspan="2">Reset the walk/run bit in byte 29 of the character's buffer to make sure he speaks slowly</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27217"></a>27217</td>
<td class="instruction">RES 7,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27219"></a>27219</td>
<td class="instruction">LD A,(32760)</td>
<td class="comment-11" rowspan="2">Now <span class="register">A</span>=LSB of the address of the SRB byte corresponding to the top line of the speech bubble</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27222"></a>27222</td>
<td class="instruction">SUB 8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27224"></a>27224</td>
<td class="instruction">LD L,A</td>
<td class="comment-11" rowspan="13">Set <span class="register">HL</span> to the display file address of the start of the top pixel line of text</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27225"></a>27225</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27226"></a>27226</td>
<td class="instruction">RRCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27227"></a>27227</td>
<td class="instruction">AND 24</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27229"></a>27229</td>
<td class="instruction">ADD A,68</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27231"></a>27231</td>
<td class="instruction">LD H,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27232"></a>27232</td>
<td class="instruction">LD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27233"></a>27233</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27234"></a>27234</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27235"></a>27235</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27236"></a>27236</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27237"></a>27237</td>
<td class="instruction">NOP</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27238"></a>27238</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27239"></a>27239</td>
<td class="instruction">LD DE,23298</td>
<td class="comment-11" rowspan="1">The speech text graphic data is stored in the 64-byte buffer at <a class="link" href="23296.html">23296</a></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27242"></a>27242</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27243"></a>27243</td>
<td class="instruction">CALL 27255</td>
<td class="comment-11" rowspan="1">Print the top 4 pixel rows of the text inside the speech bubble</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27246"></a>27246</td>
<td class="instruction">ADD A,32</td>
<td class="comment-11" rowspan="6">Set <span class="register">DE</span> to the display file address of the start of the 5th pixel row of text</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27248"></a>27248</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27249"></a>27249</td>
<td class="instruction">JR C,27256</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27251"></a>27251</td>
<td class="instruction">LD A,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27252"></a>27252</td>
<td class="instruction">SUB 8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27254"></a>27254</td>
<td class="instruction">LD D,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27255"></a>27255</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1">Save the LSB of the base display file address</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27256"></a>27256</td>
<td class="instruction">LD B,4</td>
<td class="comment-11" rowspan="1">4 pixel lines at a time</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="27258"></a>27258</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27259"></a>27259</td>
<td class="instruction">LD BC,6</td>
<td class="comment-11" rowspan="1">There are 6 character squares inside the speech bubble</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27262"></a>27262</td>
<td class="instruction">LDIR</td>
<td class="comment-11" rowspan="1">Copy a row of 6 bytes to the screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27264"></a>27264</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">Move <span class="register">HL</span> to the start of the next row of pixel data in the message buffer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27265"></a>27265</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27266"></a>27266</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">Restore the LSB of the base display file address</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27267"></a>27267</td>
<td class="instruction">INC D</td>
<td class="comment-11" rowspan="1">Next pixel row down</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27268"></a>27268</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27269"></a>27269</td>
<td class="instruction">DJNZ 27258</td>
<td class="comment-11" rowspan="1">Jump back until all 4 pixel rows in this half have been copied to the screen</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="27271"></a>27271</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="27143.html">27143</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#27144">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="27272.html">27272</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The complete Back to Skool RAM disassembly 20140614</div>
<div class="copyright">&#169; 1985 Microsphere Computer Services Ltd (Back to Skool). &#169; 2014 Richard Dymond (this disassembly).</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>